# 11장. 뉴스 피드 시스템 설계

## 뉴스 피드 시스템?

홈 페이지 중앙에 지속적으로 업데이트되는 스토리들로, 사용자 상태 정보 업데이트, 사진, 비디오, 링크, 앱 활동, 팔로우하는 사람들, 페이지, 그룹에서 나오는 좋아요 등을 포함한다 - 페이스북

## 설계 범위

- 주요 기능
- 피드에 올라오는 스토리의 순서 → 시간 순, 토픽 포인트 순 등
- 최대 팔로우 할 수 있는 친구의 수
- 트래픽 규모
- 피드에 이미지, 비디오 첨부 기능

## 설계

### 피드 발행

사용자가 스토리를 포스팅하면 해당 데이터를 캐시와 DB에 기록

새 포스팅을 친구의 뉴스 피드에 전송

- POST /v1/me/feed
    - body: content
    - Authorization header: API 호출 인증 값
- GET /v1/me/feed
    - Authorization header: API 호출 인증 값

![](/11장/image/IMG_0040.jpg)

**팬아웃(fanout)**

1. 쓰기 시점 팬아웃(push 모델): 새로운 포스팅 기록 시 해당 사용자의 캐시에 포스팅 기록. 즉시 뉴스 피드 갱신
    - 장점
        - 실시간 갱신. 친구 목록의 사용자에게 즉시 전송
        - 뉴스 피드를 읽는데 드는 시간이 짧아진다.
    - 단점
        - 핫키 이슈
        - 서비스를 자주 사용하지 않는 사용자의 피드까지 갱신하므로 컴퓨팅 자원 낭비
2. 읽기 시점 팬아웃(pull 모델): 피드를 읽는 시점에 뉴스 피드 갱신
    - 장점
        - 비활성화 사용자, 자주 사용하지 않는 사용자의 경우 컴퓨팅 자원 소모 X
        - 핫키 이슈X
    - 단점
        - 뉴스 피드 읽는데 많은 시간이 소요 됨

→ 두 방법을 결합하여 대부분은 쓰기 시점 팬아웃을 하고, 팔로워가 많은 사용자는 읽기 시점 팬아웃을 적용할 수 있다!

+안정해시를 통해 요청, 데이터를 고르게 문산시켜 핫키 이슈를 줄여볼 수 도 있다!

### 뉴스 피드 생성

모든 친구의 포스팅으로 뉴스 피드 생성

![IMG_0468.heic](/11장/image/IMG_0041.jpg)

### 캐시

![IMG_0469.heic](/11장/image/IMG_0042.jpg)

## 추가적으로 논의해볼 수 있는 이야기

- 데이터베이스 규모 확장
    - scale up vs scale out
    - SQL vs NoSQL
    - master-slvae 다중화
    - replica 읽기 연산
    - 일관성 모델
    - 데이터베이스 샤딩
    - 웹 계층 무상태로 운영하기
    - 가능한 한 많은 데이터를 캐시하는 방법
    - 여러 데이터 센터를 지원하는 방법
    - 메시지 큐를 이용하여 컴포넌트 사이의 결합도 낮추기
    - 핵심 메트릭에 대한 모니터링 (ex. 트래픽이 몰리는 시간의 QPS, 피드 새로고침 latency 등)