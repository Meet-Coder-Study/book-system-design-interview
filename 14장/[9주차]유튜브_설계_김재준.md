# 유튜브 설계



## 문제이해 및 설계 범위 확정

- 빠른 비디오 업로드
- 원할한 비디오 재생
- 재생 품질 선택기능
- 낮은 인프라 비용
- 높은 가용성과 규모 확장성, 그리고 안정성
- 지원클라이언트: 모바일앱, 웹브라우저, 그리고 스마트 TV

### 개략적 규모 추정

- 일간 능동 사용자(DAU) : 5 백만
- 한 사용자는 하루에 평균 5 개 비디오 시청
- 10%의 사용자가 하루에 1비디오 업로드
- 비디오 평균 크기는 300MB -> 비디오 저장을 위해 매일 새로 요구되는 저장 용량  -> 5백만 * 10% * 300MB =  150TB
- CDN 비용 -> 5백만 * 5비디오  * 0.3B  * $0.02  = $150,000

### 

## 개략적 설계안 제시 및 동의 구하기

- 모든 것을 밑바닥 부터 설명하여 말할 필요없다
    - 주어진 시간에 안에 적절한 기술을 골라 설계를 마치고 그 기술 각각이 어떻게 동작하는지 상세히 설명하는게 중요하다.



따라서 비디오는 CDN 에 저장하고 재생버튼을 누르면 CDN 으로부터 스트리밍이 이루어진다.

비디오 스트리밍을 제외한 모든 요청은 API 서버가 처리한다 (피드추천, 비디오 업로드 URL 생성 등)

이에따른 다음 기능에 대한 개략적인 설계를 알아보자

- 비디오 업로드 절차
- 비디오 스트리밍 절차



### 비디오 업로드 절차

<img src="https://user-images.githubusercontent.com/64793712/160635964-b110ce4c-08db-4c7a-92e4-5736864701f3.png" alt="image" style="zoom:50%;" />

**프로세스 a : 비디오 업로드**

1. 비디오를 원본 저장소에 업로드한다.
2. 트랜스코딩 서버는 원본 저장소에서 해당 비디오를 가져와 트랜스코딩을 시작한다.
3. 트랜스코딩이 완료되면 아래 두 절차가 병렬적으로 수행된다.
    1. 완료된 비디오를 트랜스코딩 비디오 저장소로 업로드한다
    2. 트랜스코딩 완료 이벤트를 트랜스코딩 완료 큐에 넣는다
        1. 트랜스코딩이 끝난 비디오를 CDN에 올린다
        2. 완료 핸들러가 이벤트 데이터를 큐에서 꺼낸다
        3. 완료 핸들러가 메타데이터 데이터베이스와 캐시를 갱신한다.
4. API 서버가 단말에게 업로드가 끝나서 스트리밍 준비가 되었음을 알린다.

**프로세스 b: 메타데이터 갱신**

원본 저장소에 파일이 업로드 되는 동안 단말은 병렬적으로 비디오 메타데이터(파일 이름, 크기, 포맷) 갱신요청을 보낸다.



### 비디오 스트리밍 절차

비디오 스트리밍을 위해 사용하는 **스트리밍 프로토콜** 종류

- MPEG_DASH
- HLS
- Microsoft Smooth Streaming
- HDS

각각의 프로토콜을 동작원리를 정확하게 알 필요도 없고 외울 필요는 없다.~~(ㅇㅈ)~~

다만 기억하는 해야하는 것은 <u>프로토콜마다 지원하는 비디오 인코딩이 다르고 플레이어도 다르다.</u>

따라서 비디오 스트리밍 서비스를 설계할 때는 서비스 용례에 맞는 프로토콜을 잘 골라 사용하자

![image](https://user-images.githubusercontent.com/64793712/160639169-955f6041-817c-4521-9216-8ab69adf4710.png)

비디오는 CDN 에서 바로 스트리밍 된다. 사용자의 단말에 가장 가까운 CDN 에지 서버가 비디오 전송을 담당한다.



## 상세설계



### 비디오 트랜스코딩

업로드된 비디오가 다른 단말에서 순조롭게 재생되려면 다른 단말과 호환되는 비트레이트와 포맷으로 저장되어야한다.

- 가공되지 않은 원본 비디오는 저장공간을 많이 차지한다.
- 사용자에게 끊김 없는 고화질 비디오 재생을 보장
    - 네트워크 대역폭이 충분하지 않으면 ?  저화질 : 고화질

등등 여러가지 이유가있는데 필요하면 보면 좋아보입니다.



이후 소개하는 아키텍쳐를 전부설명해도 별로 도움이 안될 것 같아(스트리밍 서비스를 개발하는게 아니라면..)

책에서 말하고싶은 아키텍쳐를 보면서 책에서 말하고자하는것을 요약(제 기준에서) 해보자면 다음과 같은 것 같습니다.



프로세스가 길다면 해당 프로세스를 하나의 단계로 묶어서 처리하지말고 최대한 분리하여

각각의 step 을 만들어 병렬로 처리할 수 있게 처리하라는걸 말하고 싶은 것 같습니다.

이에 따른 장점은 다음과 같아보입니다.

- 단계를 분리하였다면 실패한 단계만 재 수행을 걸어 실패시 재시도해야하는 범위를 줄 일 수 있다.
- 단계가 분리되었다면 병렬로 처리하기 쉽다.
    - 단계별 메세지 큐를 도입하여 이벤트방식으로  구성 



