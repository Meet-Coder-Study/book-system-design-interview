# 14장. 유튜브 설계
## 1. 요구사항
- 빠른 비디오 업로드
- 원활한 비디오 재생
- 재생 품질 선택 기능
- 낮은 인프라 비용
- 높은 가용성과 규모 확장성 및 안정성
- 지원 클라이언트: 모바일 앱, 웹 브라우저, 스마트 TV

<br>

## 2. 비디오 업로드 절차
<img width="800" src="https://user-images.githubusercontent.com/60383031/159300750-4ed6c3f4-fb10-42b2-bdf6-b337b5c4ffc4.png">


#### 원본 저장소
- 원본 비디오를 보관할 대형 이진 파일 저장소

#### 트랜스코딩 서버
- 비디오 포맷을 변환하는 서버 (인코딩)
- 단말이나 대역폭 요구사항에 맞는 최적의 비디오 스트림 제공하기 위해 필요

#### 트랜스코딩 저장소
- 트랜스코딩이 완료된 비디오를 저장하는 BLOB 저장소

#### 트랜스코딩 완료 큐
- 트랜스코딩 와뇰 이벤트를 보관할 메시지큐

#### 트랜스코딩 핸들러
- 트랜스코딩 완료 큐에서 이벤트 데이터를 꺼내어 메타데이터 캐시와 데이터베이스를 갱신할 작업 서버들

<br>

### 프로세스: 비디오 업로드
<img width="800" src="https://user-images.githubusercontent.com/60383031/159302279-5b85c9ff-b987-4575-bf0e-a422a2d41049.png">

- (1) 비디오를 원본 저장소에 업로드
- (2) 트랜스코딩 서버는 트랜스 코딩 시작
- (3) 트랜스코딩 완료 (아래 두 작업 병렬 실행)
    - (3a) 완료된 비디오를 트랜스코딩 비디오 저장소로 업로드
    - (3b) 트랜스코딩 완료 이벤트를 트랜스코딩 완료 큐에 넣는다.
        - (3.1) 트랜스코딩이 끝난 비디오를 CDN 에 업로드
        - (3.2) 완료 핸들러가 이벤트 데이터를 큐에서 꺼냄
        - (3.3) 

<br>

### 프로세스: 메타데이터 갱신
<img width="800" src="https://user-images.githubusercontent.com/60383031/159302400-ebd28dff-be01-4cf6-b016-22312ce939b4.png">

- 원본 저장소에 파일이 업로드되는 동안, 단말은 병렬적으로 비디오 메타데이터 갱신 요청을 API 서버에 보낸다.
- API 서버는 이 정보로 메타데이터 캐시와 데이터베이스를 업데이트한다.
- 메타데이터에 포함된 데이터: 파일 이름, 크기, 포맷 등

<br>

## 3. 비디오 스트리밍 절차

### 스트리밍
- 단말기가 원격지의 비디오로부터 지속적으로 비디오 스트림을 전송 받아 영상을 재생하는 것

### 스트리밍 프로토콜
- 스트리밍을 위해 데이터를 전송할 때 쓰이는 표준화된 통신방법
- 종류
    - MPEG
    - HLS
    - Microsoft Smooth Streaming 
    
- 프로토콜마다 지원하는 비디오 인코딩이 다르고 플레이어도 다르다.

### CDN
- 비디오는 CDN 에서 바로 스트리밍된다.
- 사용자의 단말에 가장 가까운 CDN 에지 서버가 비디오 전송을 담당할 것이다.

<br>

## 4. DAG 스케줄러 
(DAG 를 깊게 볼 필요는 없는 것 같다. 간단하게 페이스북에서 만든 스트리밍 비디오 엔진이며 순차 또는 병렬로 실행 가능함 정도만 체크)

<img width="800" src="https://user-images.githubusercontent.com/60383031/159301320-0c543e9f-76fb-4db6-854d-c13926a66822.png">

- DAG 스케줄러는 DAG 그래프를 몇 개 단계로 분할한 다음에 그 각각을 자원 관리자의 작업 큐에 넣는다.

<br>

## 5. 시스템 최적화
#### 속도 최적화: 비디오 병렬 업로드
<img width="800" src="https://user-images.githubusercontent.com/60383031/159301493-b9bfaffa-52e5-497c-84f4-7cd68cc0cb99.png">

- 비도오를 한 번의 업로드로 올리는 것은 비효울적이다.
- 따라서 아래처럼 병렬로 처리하는 것이 좋다.


<img width="800" src="https://user-images.githubusercontent.com/60383031/160091759-656b83bb-459a-46f5-a183-c961d5844458.png">

- 분할 작업을 하면 일부가 실패하더라도 빠르게 업로드를 재개할 수 있다.

<br>

#### 속도 최적화: 모든 절차를 병렬화
<img width="800" src="https://user-images.githubusercontent.com/60383031/159301569-0cbc26c1-9f22-4426-a657-3a46090bab42.png">

- 낮은 응답지연을 달성하기 위해 느슨하게 시스템을 만들어서 병렬성을 높힐 수 있다.
- 위 시스템을 보면 서로가 강하게 결합된 구조이다.
- 메시지큐를 사용하여 아래 처럼 느슨하게 변경할 수 있다.

<img width="800" src="https://user-images.githubusercontent.com/60383031/159301899-73091f89-d57e-460d-8f3a-198d19689729.png">

- 메시지큐를 도입하기 전에 인코딩 모듈은 다운로드 모듈의 작업이 끝나기를 기다려야 했다.
- 메시지큐가 도입되면 인코딩 모듈은 다운로드 모듈의 작업이 끝나기를 더 이상 기다릴 필요가 없다.


